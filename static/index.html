<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Grounded Evidence QA</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<style>
		.loader {
			border-top-color: #3498db;
			animation: spinner 1.5s linear infinite;
		}

		@keyframes spinner {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		.hidden {
			display: none;
		}
	</style>
</head>

<body class="bg-slate-50 min-h-screen font-sans">

	<div class="max-w-4xl mx-auto py-12 px-4">
		<header class="text-center mb-10">
			<div class="flex flex-col items-center">
				<h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">Grounded Evidence QA</h1>
				<p class="text-slate-600 mt-3 text-lg">Upload documents and get answers backed by verified evidence.</p>

				<div class="mt-6 flex flex-wrap justify-center gap-4 items-center">
					<div
						class="inline-flex items-center px-4 py-2 rounded-full bg-slate-200 border border-slate-300 shadow-sm">
						<span class="text-xs font-bold text-slate-500 uppercase mr-2 tracking-widest">Active Doc
							ID:</span>
						<code id="idMonitor" class="text-blue-700 font-mono font-bold">Not Defined Yet</code>
					</div>

					<div
						class="flex items-center gap-2 px-4 py-2 rounded-full bg-white border border-slate-200 shadow-sm">
						<div id="healthDot" class="w-2.5 h-2.5 rounded-full bg-slate-300"></div>
						<span id="healthStatus"
							class="text-xs font-bold text-slate-500 uppercase tracking-wider">Status: Unknown</span>
						<button onclick="checkHealth()" id="healthBtn"
							class="ml-2 hover:bg-slate-100 p-1 rounded-md transition-colors">
							<svg id="healthIcon" class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor"
								viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
								</path>
							</svg>
						</button>
					</div>
				</div>
			</div>
		</header>

		<div class="grid gap-8">
			<section class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
				<div class="flex items-center mb-6">
					<div
						class="bg-blue-100 text-blue-600 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">
						1</div>
					<h2 class="text-xl font-bold text-slate-800">Upload Document</h2>
				</div>

				<div class="flex flex-col sm:flex-row gap-4">
					<input type="file" id="fileInput" accept=".txt"
						class="block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-all" />

					<button onclick="uploadFile()" id="uploadBtn"
						class="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 flex items-center justify-center min-w-[120px]">
						<span id="uploadBtnText">Upload</span>
						<div id="uploadLoader" class="loader w-5 h-5 border-2 border-white rounded-full ml-2 hidden">
						</div>
					</button>
				</div>
				<p id="uploadResult" class="mt-4 text-sm font-medium italic text-slate-500">Ready for upload...</p>
			</section>

			<section id="askSection"
				class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 opacity-50 pointer-events-none transition-all duration-300">
				<div class="flex items-center mb-6">
					<div
						class="bg-green-100 text-green-600 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">
						2</div>
					<h2 class="text-xl font-bold text-slate-800">Ask Question</h2>
				</div>

				<textarea id="question" rows="3" placeholder="Enter your question here..."
					class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all mb-4 text-slate-700"></textarea>

				<div class="flex gap-4">
					<button onclick="askQuestion()" id="askBtn"
						class="bg-green-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-green-700 disabled:opacity-50 flex items-center justify-center">
						<span id="askBtnText">Get Answer</span>
						<div id="askLoader" class="loader w-5 h-5 border-2 border-white rounded-full ml-2 hidden"></div>
					</button>
					<button onclick="clearSession()"
						class="text-slate-400 text-sm hover:text-red-500 transition-colors">Clear Document</button>
				</div>
			</section>

			<section id="answerSection" class="bg-white p-8 rounded-2xl shadow-md border-l-4 border-l-blue-500 hidden">
				<div class="flex justify-between items-start mb-6">
					<h2 class="text-2xl font-bold text-slate-800">Answer</h2>
					<div class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-sm font-bold">
						Confidence: <span id="confidenceText">0%</span>
					</div>
				</div>
				<p id="answerText" class="text-slate-700 leading-relaxed text-lg mb-8"></p>
				<h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Supporting Evidence</h3>
				<div id="evidenceList" class="space-y-4"></div>
			</section>
		</div>
	</div>

	<script>
		const API_BASE = "";
		let currentDocumentId = sessionStorage.getItem('saved_doc_id') || null;

		window.onload = () => {
			updateIdDisplay(currentDocumentId);
			checkHealth(); // Auto-check on load
		};

		// --- Health Check Function ---
		async function checkHealth() {
			const dot = document.getElementById("healthDot");
			const status = document.getElementById("healthStatus");
			const icon = document.getElementById("healthIcon");

			icon.classList.add("animate-spin");

			try {
				const res = await fetch(`${API_BASE}/health`);
				const data = await res.json();

				if (data.success) {
					dot.className = "w-2.5 h-2.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]";
					status.textContent = "Status: Healthy";
					status.className = "text-xs font-bold text-green-600 uppercase tracking-wider";
				} else {
					throw new Error(data.message || "Unhealthy");
				}
			} catch (error) {
				dot.className = "w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.6)]";
				status.textContent = "Status: Error";
				status.className = "text-xs font-bold text-red-600 uppercase tracking-wider";
				console.error("Health Check Failed:", error);
			} finally {
				setTimeout(() => icon.classList.remove("animate-spin"), 500);
			}
		}

		function updateIdDisplay(id) {
			currentDocumentId = id;
			const monitor = document.getElementById("idMonitor");
			const askSection = document.getElementById("askSection");

			monitor.textContent = id === null ? "Not Defined Yet" : id;

			if (id) {
				sessionStorage.setItem('saved_doc_id', id);
				askSection.classList.remove("opacity-50", "pointer-events-none");
				monitor.className = "text-green-600 font-mono font-bold";
			} else {
				sessionStorage.removeItem('saved_doc_id');
				askSection.classList.add("opacity-50", "pointer-events-none");
				monitor.className = "text-blue-700 font-mono font-bold";
			}
		}

		function clearSession() {
			updateIdDisplay(null);
			document.getElementById("uploadResult").textContent = "Session cleared.";
			document.getElementById("answerSection").classList.add("hidden");
			document.getElementById("question").value = "";
		}

		function toggleLoading(btnId, loaderId, textId, isLoading, originalText) {
			const btn = document.getElementById(btnId);
			const loader = document.getElementById(loaderId);
			const text = document.getElementById(textId);
			btn.disabled = isLoading;
			isLoading ? loader.classList.remove('hidden') : loader.classList.add('hidden');
			text.textContent = isLoading ? "Processing..." : originalText;
		}

		async function uploadFile() {
			const fileInput = document.getElementById("fileInput");
			const resultDisplay = document.getElementById("uploadResult");

			if (!fileInput.files.length) {
				resultDisplay.className = "mt-4 text-sm font-medium text-red-500";
				resultDisplay.textContent = "Please select a file.";
				return;
			}

			toggleLoading("uploadBtn", "uploadLoader", "uploadBtnText", true, "Upload");

			const formData = new FormData();
			formData.append("file", fileInput.files[0]);

			try {
				const res = await fetch(`${API_BASE}/ingest`, { method: "POST", body: formData });
				if (!res.ok) throw new Error(`Server returned ${res.status}`);

				const responseData = await res.json();
				const newId = responseData.document_id || responseData.data?.document_id;

				if (newId !== undefined && newId !== null) {
					updateIdDisplay(newId);
					resultDisplay.className = "mt-4 text-sm font-medium text-green-600";
					resultDisplay.textContent = "Upload Successful!";
				} else {
					throw new Error("No document_id found in response");
				}
			} catch (error) {
				resultDisplay.className = "mt-4 text-sm font-medium text-red-500";
				resultDisplay.textContent = `Error: ${error.message}`;
				updateIdDisplay(null);
			} finally {
				toggleLoading("uploadBtn", "uploadLoader", "uploadBtnText", false, "Upload");
			}
		}

		async function askQuestion() {
			const questionText = document.getElementById("question").value;
			if (!currentDocumentId || !questionText.trim()) return;

			toggleLoading("askBtn", "askLoader", "askBtnText", true, "Get Answer");

			try {
				const res = await fetch(`${API_BASE}/ask`, {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({
						documentId: Number(currentDocumentId),
						question: questionText
					})
				});

				if (!res.ok) throw new Error("Question failed");
				const data = await res.json();

				document.getElementById("answerSection").classList.remove("hidden");
				document.getElementById("answerText").textContent = data.answer;
				document.getElementById("confidenceText").textContent = (data.confidence * 100).toFixed(1) + "%";

				const list = document.getElementById("evidenceList");
				list.innerHTML = "";
				data.evidence.forEach(ev => {
					const div = document.createElement("div");
					div.className = "p-4 rounded-xl bg-slate-100 border border-slate-200";
					div.innerHTML = `<p class="text-slate-800 text-sm italic">"${ev.text} <span class="font-bold text-md text-slate-500">[similarity: ${(ev.similarity).toFixed(4)}]</span>"</p>`;
					list.appendChild(div);
				});

				document.getElementById("answerSection").scrollIntoView({ behavior: 'smooth' });
			} catch (error) {
				alert(error.message);
			} finally {
				toggleLoading("askBtn", "askLoader", "askBtnText", false, "Get Answer");
			}
		}
	</script>
</body>

</html>